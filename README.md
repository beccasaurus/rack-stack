RackStack
=========

`RackStack` is a fully managed stack of Rack applications (*inspired by [Rack::Builder][]*)

Installation
------------

```ruby
gem "rack-stack"
```

Usage
-----

```ruby
require "rack/stack"

rack_stack = RackStack.new do
  use MyMiddleware
  map "/admin" do
    run AdminApp.new
  end
  run MyApp.new
end

# A RackStack instance is a Rack application, so you can #call it.
rack_stack.call(env)
```
If you're familar with Rack::Builder, that should look very familiar!

RackStack's API is actually intended to be [compatible with Rack::Builder's][compatibility].

RackStack offers a number of additional features:

 1. Conditional Logic
 1. Named Applications
 1. Stack Manipulation
 1. Use as Middleware

Conditional Logic
-----------------

RackStack allows you to easily add conditional logic for `:when` to `#run`, `#use`, or `#map` a rack component.

```ruby
RackStack.new do

  # When a block is given with 1 argument, the current request will be yielded (as a Rack::Request)
  use MyMiddleware, when: ->(request){ request.path_info =~ /about-us/ }

  # When a block is given with no arguments, the block is evaluated against the current request
  use MyMiddleware, when: ->{ path_info =~ /about-us/ }

  # When a Hash (or Array of pairs) is given, each value will be compared against the value from the 
  # current request.  In this example, the following would be evaluated: /about-us/ === "<the path info>"
  use MyMiddleware, when: { path_info: /about-us/ }

end
```

Named Applications
------------------

add names ...

remove ...

get access to...

Stack Manipulation
------------------

A `RackStack` may be manipulated at runtime.

```ruby
rack_stack = RackStack.new

# You can run the RackStack or something else, eg. mount it with Artifice
some_rack_server.run(rack_stack)

# #use, #run, and #map may be used at runtime
rack_stack.use :my_middleware, SomeMiddleware
rack_stack.run SomeApp.new, when: { host: "someapp.com" }
rack_stack.map "/foo" do
  use FooMiddleware
  run FooApp.new
end

# and feel free to #remove named applications
rack_stack.remove :my_middleware

# or manipulate the stack Array directly (with the help of RackStack::use/run/map)
rack_stack.stack.insert 1, RackStack.use(:my_middleware, SomeMiddleware)
```

Use as Middleware
-----------------

A Rack application generated by a Rack::Builder can only be run as a Rack endpoint,
not as a middleware.

RackStack can be run as either a Rack endpoint or a Rack middleware.

```ruby
Rack::Builder.new {
  use SomeMiddleware

  # RackStack can be used as a middleware, alongside your existing Rack components
  use RackStack.new do
    use AnotherMiddleware
    run SomeApplication.new
  end

  # Or RackStack can be used as a Rack endpoint.
  run RackStack.new do
    run AnotherApplication.new  
  end
}.to_app
```

[Rack::Builder]: http://rack.rubyforge.org/doc/classes/Rack/Builder.html
[compatibility]: https://github.com/remi/rack-stack/tree/master/spec/rack-builder-compatibility
